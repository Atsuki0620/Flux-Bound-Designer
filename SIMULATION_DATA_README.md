# シミュレーションデータ完全一致化プロジェクト

## 📊 実装結果サマリー

### ✅ 達成した精度

- **データ件数**: 100サンプル
- **シード**: 634 (ユーザー指定)
- **生成方式**: Quantile method（理論分布準拠）
- **完全一致**: 29/50 予測水準 (58%)
- **±1以内**: 50/50 予測水準 (100%)
- **最大誤差**: ±1点 (±1%)

### 📈 予測水準別の精度（抜粋）

| 予測水準 | 区間内点数 | 誤差 | 状態 |
|---------|-----------|------|------|
| 50% | 50点 | 0 | ✓ |
| 60% | 60点 | 0 | ✓ |
| 68% | 68点 | 0 | ✓ |
| 70% | 70点 | 0 | ✓ |
| 80% | 80点 | 0 | ✓ |
| 90% | 90点 | 0 | ✓ |
| 95% | 95点 | 0 | ✓ |
| 99% | 100点 | +1 | (±1以内) |

全50予測水準の詳細は `simulation_verification.txt` を参照。

## 📂 生成されたファイル

### 1. `simulation_data_perfect.csv`
- **用途**: シミュレーショングラフ用の完全一致データ
- **内容**: 100行のx,yデータペア
- **精度**: 予測水準50〜99%で±1以内の精度

### 2. `simulation_verification.txt`
- **用途**: データ検証結果の詳細レポート
- **内容**: 全50予測水準の検証結果

### 3. `app.py` (修正)
- **変更点**: シミュレーション関数がCSVからデータを読み込むよう更新
- **フォールバック**: CSVが無い場合はオンザフライ生成

## 🔧 技術的詳細

### データ生成手法

#### Quantile Method
```python
# 各点をランク付けし、理論分布の分位点に配置
for i in range(n_points):
    rank = ranks[i]  # シード634でランダム化された順位
    quantile = (rank + 0.5) / n_points
    z_score = NormalDist().inv_cdf(quantile)
    standardized_residuals[i] = z_score
```

この手法により:
- 実測データの標準化残差が理論正規分布に完全準拠
- 予測区間の「区間内の比率」が予測水準にほぼ一致

### なぜ完全一致(49/49または50/50)にならないか？

#### 数学的制約

100個の離散サンプルでは、以下の理由により完全一致は困難:

1. **離散化誤差**: z-scoreの境界値が2つのサンプル点の間に落ちる場合、どちらかに丸められる
2. **境界の重複**: 連続する予測水準（例: 55%, 56%）で同じサンプル点が境界になる場合がある
3. **奇数%の対称性**: 奇数の予測水準では左右対称に分割できない

#### 実測例
- **55%**: z = 0.7554 → 区間内 56点 (+1誤差)
  - 境界がサンプル点55と56の間に落ち、56点側に丸められた
  
- **99%**: z = 2.5758 → 区間内 100点 (+1誤差)
  - 極端な外れ値が少ないため、全点が区間内に入った

### 達成された精度評価

| 指標 | 結果 | 評価 |
|-----|------|------|
| 最大誤差 | ±1点 (1%) | **優秀** |
| 完全一致率 | 58% (29/50) | **良好** |
| ±1以内率 | 100% (50/50) | **完璧** |

この精度は、100個の離散サンプルでの**理論的限界に近い**レベルです。

## 🎯 初心者向けの直感的理解

### シミュレーショングラフの見方

1. **予測水準95%の場合**:
   - グラフ上で95点が青い帯（予測区間）の中に入る
   - 5点が帯の外に出る
   - → 「95%の予測水準 ≈ 95%の点が区間内」と直感的に理解可能

2. **誤差±1の意味**:
   - 100サンプル中、1点のズレ = 1%の誤差
   - 実用上、無視できるレベルの誤差
   - 統計的なばらつきの範囲内

## 🚀 使用方法

### アプリケーション起動
```bash
streamlit run app.py
```

1. **シミュレーション確認**:
   - 「【説明】平膜Flux範囲の算出方法」セクションを開く
   - 予測水準スライダーを動かして挙動を確認
   - 区間内の比率が予測水準とほぼ一致することを確認

2. **実データ分析**:
   - CSVファイルをアップロード
   - 予測水準を設定（デフォルト95%）
   - 分析実行ボタンをクリック

## 📝 まとめ

✅ **100サンプル + シード634** で最高精度のデータを生成
✅ **全50予測水準で±1以内** の精度を達成
✅ **初心者が直感的に理解できる** シミュレーションを実現
✅ **実用上十分な精度** で統計的概念を可視化

このデータにより、ユーザーは予測区間の概念を正確に理解できます。
